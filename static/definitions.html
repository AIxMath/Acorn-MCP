<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Definitions - Acorn MCP</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">Acorn MCP</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/theorems.html" class="nav-link">Theorems</a>
                <a href="/definitions.html" class="nav-link active">Definitions</a>
                <a href="/create.html" class="nav-link">Create</a>
            </div>
        </div>
    </nav>

    <div class="content">
        <div class="container">
            <!-- Header -->
            <section style="padding: 2rem 0 3rem;">
                <h1 style="margin-bottom: 1rem;">Definitions</h1>
                <p style="font-size: 1.125rem; max-width: 700px;">
                    Search and browse all definitions. Search covers names and definition text.
                </p>
            </section>

            <!-- Search Bar -->
            <div class="search-bar">
                <input
                    type="search"
                    id="search-input"
                    placeholder="Search definitions by name or text..."
                >
                <button class="btn btn-primary" id="search-btn">Search</button>
                <button class="btn btn-ghost" id="clear-btn">Clear</button>
            </div>

            <!-- Stats -->
            <div style="color: var(--text-muted); margin-bottom: 2rem;">
                <span id="results-info">Loading...</span>
            </div>

            <!-- Results -->
            <div id="results-container" class="items-list">
                <div class="loading">Loading definitions...</div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination-container" style="display: none;">
                <div class="pagination-controls">
                    <button class="btn btn-secondary" id="prev-btn" disabled>Previous</button>
                    <button class="btn btn-primary" id="next-btn" disabled>Next</button>
                </div>
                <div class="pagination-info" id="page-info"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Acorn MCP - Mathematical Knowledge Base</p>
            <div class="footer-links">
                <a href="/theorems.html" class="footer-link">Theorems</a>
                <a href="/definitions.html" class="footer-link">Definitions</a>
                <a href="/create.html" class="footer-link">Create</a>
                <a href="/api/theorems?page=1&page_size=20" class="footer-link">API</a>
            </div>
        </div>
    </footer>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentQuery = '';
        const pageSize = 20;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function renderDefinition(definition) {
            return `
                <div class="item">
                    <div class="item-header">
                        <div>
                            <div class="item-title">${escapeHtml(definition.name)}</div>
                            <div class="item-meta">Added ${formatDate(definition.created_at)}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="badge" style="cursor: pointer; background: var(--bg-tertiary); border: 1px solid var(--border-default);" onclick="toggleDependencies('${escapeHtml(definition.name)}', this)">
                                Show Dependencies
                            </button>
                            <span class="badge">Definition</span>
                        </div>
                    </div>

                    <div class="dependencies-container" id="deps-${escapeHtml(definition.name).replace(/\./g, '-')}" style="display: none; margin-bottom: 1rem;">
                        <div class="loading" style="padding: 1rem; text-align: center;">Loading dependencies...</div>
                    </div>

                    <div class="code-section">
                        <div class="code-label">Definition</div>
                        <pre class="code-block">${escapeHtml(definition.definition)}</pre>
                    </div>
                </div>
            `;
        }

        async function loadDefinitions(page = 1) {
            const resultsContainer = document.getElementById('results-container');
            const resultsInfo = document.getElementById('results-info');
            const paginationContainer = document.getElementById('pagination-container');

            resultsContainer.innerHTML = '<div class="loading">Loading definitions...</div>';

            try {
                const queryParam = currentQuery ? `&q=${encodeURIComponent(currentQuery)}` : '';
                const response = await fetch(`/api/definitions?page=${page}&page_size=${pageSize}${queryParam}`);
                const data = await response.json();

                currentPage = data.page;
                totalPages = data.pages;

                // Update results info
                const filterNote = currentQuery ? ` matching "${currentQuery}"` : '';
                resultsInfo.textContent = `${data.total} definition${data.total !== 1 ? 's' : ''}${filterNote}`;

                // Render definitions
                if (!data.definitions || data.definitions.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <h3 style="margin-bottom: 0.5rem;">No definitions found</h3>
                            <p style="color: var(--text-muted);">${currentQuery ? 'Try a different search query' : 'Add your first definition to get started'}</p>
                            ${!currentQuery ? '<a href="/create.html" class="btn btn-primary" style="margin-top: 1rem;">Add Definition</a>' : ''}
                        </div>
                    `;
                    paginationContainer.style.display = 'none';
                } else {
                    resultsContainer.innerHTML = data.definitions.map(renderDefinition).join('');

                    // Update pagination
                    paginationContainer.style.display = 'flex';
                    document.getElementById('prev-btn').disabled = currentPage <= 1;
                    document.getElementById('next-btn').disabled = currentPage >= totalPages;
                    document.getElementById('page-info').textContent =
                        `Page ${currentPage} of ${totalPages}`;
                }
            } catch (error) {
                console.error('Error loading definitions:', error);
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 style="margin-bottom: 0.5rem; color: var(--error);">Error loading definitions</h3>
                        <p style="color: var(--text-muted);">Please try again later</p>
                    </div>
                `;
                paginationContainer.style.display = 'none';
            }
        }

        // Event listeners
        document.getElementById('search-btn').addEventListener('click', () => {
            currentQuery = document.getElementById('search-input').value.trim();
            loadDefinitions(1);
        });

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentQuery = document.getElementById('search-input').value.trim();
                loadDefinitions(1);
            }
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            currentQuery = '';
            document.getElementById('search-input').value = '';
            loadDefinitions(1);
        });

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadDefinitions(currentPage - 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadDefinitions(currentPage + 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Initial load
        loadDefinitions(1);

        // Toggle dependencies
        const loadedDeps = new Set();
        window.toggleDependencies = async function(name, button) {
            const safeId = name.replace(/\./g, '-');
            const container = document.getElementById(`deps-${safeId}`);

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'Hide Dependencies';

                // Load dependencies if not already loaded
                if (!loadedDeps.has(name)) {
                    try {
                        const response = await fetch(`/api/dependencies/${encodeURIComponent(name)}`);
                        const data = await response.json();

                        if (data.dependencies && data.dependencies.length > 0) {
                            const depsList = data.dependencies
                                .map(dep => `<div style="padding: 0.5rem; background: var(--bg-primary); border-radius: 6px; font-family: monospace; font-size: 0.9rem;">${escapeHtml(dep.target_name)}<span style="color: var(--text-muted); margin-left: 0.5rem;">(${dep.dependency_type})</span></div>`)
                                .join('');
                            container.innerHTML = `
                                <div style="padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Dependencies (${data.count})</div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        ${depsList}
                                    </div>
                                </div>
                            `;
                        } else {
                            container.innerHTML = `
                                <div style="padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 8px; color: var(--text-muted); text-align: center;">
                                    No dependencies found
                                </div>
                            `;
                        }
                        loadedDeps.add(name);
                    } catch (error) {
                        console.error('Error loading dependencies:', error);
                        container.innerHTML = `
                            <div style="padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 8px; color: var(--error); text-align: center;">
                                Error loading dependencies
                            </div>
                        `;
                    }
                }
            } else {
                container.style.display = 'none';
                button.textContent = 'Show Dependencies';
            }
        };
    </script>
</body>
</html>
