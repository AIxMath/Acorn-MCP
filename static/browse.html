<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse - Acorn MCP</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">Acorn MCP</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/browse.html" class="nav-link active">Browse</a>
                <a href="/create.html" class="nav-link">Create</a>
            </div>
        </div>
    </nav>

    <div class="content">
        <div class="container">
            <!-- Header -->
            <section style="padding: 2rem 0 2rem;">
                <h1 style="margin-bottom: 1rem;">Browse Acorn Library</h1>
                <p style="font-size: 1.125rem; max-width: 700px;">
                    Search and browse theorems, definitions, typeclasses, structures, and more.
                </p>
            </section>

            <!-- Filter Tabs -->
            <div class="filter-tabs" style="margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="filter-tab active" data-kind="">All</button>
                <button class="filter-tab" data-kind="theorem">Theorems</button>
                <button class="filter-tab" data-kind="typeclass">Typeclasses</button>
                <button class="filter-tab" data-kind="structure">Structures</button>
                <button class="filter-tab" data-kind="define">Definitions</button>
                <button class="filter-tab" data-kind="typeclass_method">TC Methods</button>
                <button class="filter-tab" data-kind="typeclass_field">TC Fields</button>
                <button class="filter-tab" data-kind="typeclass_axiom">TC Axioms</button>
                <button class="filter-tab" data-kind="attributes_method">Attr Methods</button>
                <button class="filter-tab" data-kind="attributes_constant">Attr Constants</button>
                <button class="filter-tab" data-kind="inductive">Inductives</button>
            </div>

            <!-- Search Bar -->
            <div class="search-bar">
                <input
                    type="search"
                    id="search-input"
                    placeholder="Search by name or source..."
                >
                <button class="btn btn-primary" id="search-btn">Search</button>
                <button class="btn btn-ghost" id="clear-btn">Clear</button>
            </div>

            <!-- Stats -->
            <div style="color: var(--text-muted); margin-bottom: 2rem;">
                <span id="results-info">Loading...</span>
            </div>

            <!-- Results -->
            <div id="results-container" class="items-list">
                <div class="loading">Loading items...</div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination-container" style="display: none;">
                <div class="pagination-controls">
                    <button class="btn btn-secondary" id="prev-btn" disabled>Previous</button>
                    <button class="btn btn-primary" id="next-btn" disabled>Next</button>
                </div>
                <div class="pagination-info" id="page-info"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Acorn MCP - Mathematical Knowledge Base</p>
            <div class="footer-links">
                <a href="/browse.html" class="footer-link">Browse</a>
                <a href="/create.html" class="footer-link">Create</a>
                <a href="/api/items?page=1&page_size=20" class="footer-link">API</a>
            </div>
        </div>
    </footer>

    <style>
        .filter-tabs {
            border-bottom: 1px solid var(--border-default);
            padding-bottom: 1rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            color: var(--text-primary);
        }

        .filter-tab:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .filter-tab.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
            font-weight: 600;
        }

        .kind-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            font-family: monospace;
        }

        .kind-theorem { background: #1a1a1a; color: #fff; }
        .kind-typeclass { background: #2a2a2a; color: #fff; }
        .kind-structure { background: #3a3a3a; color: #fff; }
        .kind-define { background: #4a4a4a; color: #fff; }
        .kind-other { background: #5a5a5a; color: #fff; }

        .identifier-link {
            color: var(--text-primary);
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .identifier-link:hover {
            color: #666;
            text-decoration-style: solid;
        }
    </style>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentQuery = '';
        let currentKind = '';
        const pageSize = 20;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getKindLabel(kind) {
            const labels = {
                'theorem': 'Theorem',
                'axiom': 'Axiom',
                'typeclass': 'Typeclass',
                'typeclass_method': 'TC Method',
                'typeclass_field': 'TC Field',
                'typeclass_axiom': 'TC Axiom',
                'structure': 'Structure',
                'inductive': 'Inductive',
                'define': 'Definition',
                'attributes_method': 'Attr Method',
                'attributes_constant': 'Attr Constant'
            };
            return labels[kind] || kind;
        }

        function getKindBadgeClass(kind) {
            if (kind.includes('theorem') || kind.includes('axiom')) return 'kind-theorem';
            if (kind.includes('typeclass')) return 'kind-typeclass';
            if (kind.includes('structure') || kind.includes('inductive')) return 'kind-structure';
            if (kind.includes('define') || kind.includes('attributes')) return 'kind-define';
            return 'kind-other';
        }

        // Cache for known identifiers (populated from API)
        let knownIdentifiers = new Set();

        function makeIdentifiersClickable(source) {
            if (knownIdentifiers.size === 0) {
                return escapeHtml(source);
            }

            // Escape HTML first
            let escaped = escapeHtml(source);

            // Pattern to match qualified identifiers (e.g., Complex.add, AddGroup.neg)
            // Also match simple identifiers at word boundaries
            const identifierPattern = /\b([A-Z][A-Za-z0-9_]*(?:\.[a-z_][A-Za-z0-9_]*)*|[a-z_][a-z0-9_]*)\b/g;

            // Replace identifiers with links if they're known
            escaped = escaped.replace(identifierPattern, (match) => {
                if (knownIdentifiers.has(match)) {
                    // Create a clickable link that jumps to the identifier's detail page
                    return `<a href="/item.html?name=${encodeURIComponent(match)}" class="identifier-link">${escapeHtml(match)}</a>`;
                }
                return match;
            });

            return escaped;
        }

        function renderItem(item) {
            const kindBadgeClass = getKindBadgeClass(item.kind);
            const kindLabel = getKindLabel(item.kind);

            // Truncate source for display
            const maxSourceLength = 500;
            const source = item.source.length > maxSourceLength
                ? item.source.substring(0, maxSourceLength) + '...'
                : item.source;

            // Add item name to known identifiers
            knownIdentifiers.add(item.name);

            // Make identifiers clickable in the source
            const sourceHtml = makeIdentifiersClickable(source);

            return `
                <div class="item">
                    <div class="item-header">
                        <div style="flex: 1; min-width: 0;">
                            <a href="/item.html?name=${encodeURIComponent(item.name)}" class="item-title" style="text-decoration: none; color: inherit; cursor: pointer;">
                                ${escapeHtml(item.name)}
                            </a>
                            <div class="item-meta">
                                ${item.file_path ? `${escapeHtml(item.file_path)}` : ''}
                                ${item.line_number ? `:${item.line_number}` : ''}
                                ${item.created_at ? `â€¢ Added ${formatDate(item.created_at)}` : ''}
                            </div>
                        </div>
                        <span class="kind-badge ${kindBadgeClass}">${kindLabel}</span>
                    </div>

                    <div class="code-section">
                        <pre class="code-block">${sourceHtml}</pre>
                    </div>
                </div>
            `;
        }

        function searchFor(identifier) {
            currentQuery = identifier;
            document.getElementById('search-input').value = identifier;
            loadItems(1);
        }

        async function loadItems(page = 1) {
            const resultsContainer = document.getElementById('results-container');
            const resultsInfo = document.getElementById('results-info');
            const paginationContainer = document.getElementById('pagination-container');

            resultsContainer.innerHTML = '<div class="loading">Loading items...</div>';

            try {
                const queryParam = currentQuery ? `&q=${encodeURIComponent(currentQuery)}` : '';
                const kindParam = currentKind ? `&kind=${encodeURIComponent(currentKind)}` : '';
                const response = await fetch(`/api/items?page=${page}&page_size=${pageSize}${queryParam}${kindParam}`);
                const data = await response.json();

                currentPage = data.page;
                totalPages = data.pages;

                // Update results info
                const kindNote = currentKind ? ` of type "${getKindLabel(currentKind)}"` : '';
                const filterNote = currentQuery ? ` matching "${currentQuery}"` : '';
                resultsInfo.textContent = `${data.total} item${data.total !== 1 ? 's' : ''}${kindNote}${filterNote}`;

                // Render items
                if (!data.items || data.items.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <h3 style="margin-bottom: 0.5rem;">No items found</h3>
                            <p style="color: var(--text-muted);">${currentQuery || currentKind ? 'Try a different filter or search query' : 'Add your first item to get started'}</p>
                            ${!currentQuery && !currentKind ? '<a href="/create.html" class="btn btn-primary" style="margin-top: 1rem;">Add Item</a>' : ''}
                        </div>
                    `;
                    paginationContainer.style.display = 'none';
                } else {
                    resultsContainer.innerHTML = data.items.map(renderItem).join('');

                    // Update pagination
                    paginationContainer.style.display = 'flex';
                    document.getElementById('prev-btn').disabled = currentPage <= 1;
                    document.getElementById('next-btn').disabled = currentPage >= totalPages;
                    document.getElementById('page-info').textContent =
                        `Page ${currentPage} of ${totalPages}`;
                }
            } catch (error) {
                console.error('Error loading items:', error);
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 style="margin-bottom: 0.5rem; color: var(--error);">Error loading items</h3>
                        <p style="color: var(--text-muted);">Please try again later</p>
                    </div>
                `;
                paginationContainer.style.display = 'none';
            }
        }

        // Filter tab clicks
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Set current kind and reload
                currentKind = tab.dataset.kind;
                loadItems(1);
            });
        });

        // Search event listeners
        document.getElementById('search-btn').addEventListener('click', () => {
            currentQuery = document.getElementById('search-input').value.trim();
            loadItems(1);
        });

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentQuery = document.getElementById('search-input').value.trim();
                loadItems(1);
            }
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            currentQuery = '';
            document.getElementById('search-input').value = '';
            loadItems(1);
        });

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadItems(currentPage - 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadItems(currentPage + 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Preload identifier index for linking
        async function preloadIdentifiers() {
            try {
                // Fetch a sample of item names to populate the identifier cache
                // We'll fetch the first 1000 items to build a reasonable index
                const response = await fetch('/api/items?page=1&page_size=100');
                const data = await response.json();

                if (data.items) {
                    data.items.forEach(item => {
                        knownIdentifiers.add(item.name);
                        // Also add simple name without module prefix for better matching
                        const simpleName = item.name.split('.').pop();
                        if (simpleName && simpleName.length > 2) { // Skip very short names
                            knownIdentifiers.add(simpleName);
                        }
                    });
                }
            } catch (error) {
                console.error('Error preloading identifiers:', error);
            }
        }

        // Initial load
        preloadIdentifiers().then(() => {
            loadItems(1);
        });
    </script>
</body>
</html>
